buildPack: none
pipelineConfig:
  extends:
    file: ../pipeline.yaml
  agent:
    label: jenkins-nodejs
    container: nodejs
  pipelines:
    pullRequest:
      build:
        steps:
        - sh: jx step credential -s npm-token -k file -f /builder/home/.npmrc --optional=true
          name: npmrc
        - sh: npm install
          name: npm-install
        - sh: CI=true DISPLAY=:99 npm test
          name: npm-test
    release:
      setup:
        steps:
        - groovy: git 'https://REPLACE_ME_GIT_PROVIDER/REPLACE_ME_ORG/REPLACE_ME_APP_NAME.git'
          when: "prow"
        - sh: git checkout master
          comment: ensure we're not on a detached head
          when: "!prow"
        - sh: git config --global credential.helper store
          when: "!prow"
        - sh: jx step git credentials
          when: "!prow"
      setVersion:
        steps:
        - sh: echo \$(jx-release-version) > VERSION
          name: next-version
          comment: so we can retrieve the version in later steps
        # TODO modify package.json?
        - sh: jx step tag --version \$(cat VERSION)
          name: tag-version
      build:
        steps:
        - sh: jx step credential -s npm-token -k file -f /builder/home/.npmrc --optional=true
          name: npmrc
        - sh: npm install
          name: npm-install
        - sh: CI=true DISPLAY=:99 npm test
          name: npm-test
      post:
        steps:
        - groovy: always
          when: "!prow"
          steps:
            - groovy: "cleanWs()"